<!DOCTYPE html>
<html lang="ko">
<head class="h-100">
  <title>도감작 계산기 :: LoChart</title>
  <meta name="description" content="로스트아크 도감작 계산기">
  <script>var here = "cardcalc";</script>

  <!-- jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="js/jquery.cookie-1.4.1.min.js" > </script>

  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

  <!-- custom -->
  <script src="js/custom.js"></script>
  <link rel="stylesheet" type="text/css" href="css/custom.css">

  <!-- google ADSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4936470262963011"
     crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/ubhor-phi@latest/dist/script.min.js"></script>
  <meta name="adshield-analytics-verification" content="d7b8eb3d-f8fa-41ae-9794-c05e2ed4deb8"/>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XD44D79GLY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XD44D79GLY');
  </script>

  <style>
    @media (max-width: 992px) {
      .w-50 {
        width: 100%!important;
      }
    }
    body {
      font-family: sans-serif;
    }
    a {
      color: #369;
    }
    .note {
      width: 500px;
      margin: 50px auto;
      font-size: 1.1em;
      color: #333;
      text-align: justify;
    }
    #drop-area {
      border: 2px dashed #ccc;
      border-radius: 20px;
      width: 90%;
      margin: 50px auto;
      padding: 20px;
    }
    #drop-area.highlight {
      border-color: purple;
    }
    p {
      margin-top: 0;
    }
    .my-form {
      margin-bottom: 10px;
    }
    #gallery {
      margin-top: 10px;
    }
    #gallery img {
      width: 48%;
      margin-bottom: 10px;
      margin-right: 10px;
      vertical-align: middle;
    }
    #fileElem {
      display: none;
    }
  </style>
  <link href="css/cover.css" rel="stylesheet">
</head>

<body class="d-flex h-100 text-center text-white bg-dark">
  <div class="container d-flex w-100 h-100 p-3 mx-auto flex-column">

    <header class="mb-3">
      <div>
        <a href="/"><h3 class="float-md-start mb-0 text-white">LoChart</h3></a>
        <nav class="nav nav-masthead justify-content-center float-md-end"></nav>
      </div>
    </header>

    <main class="pt-5 pb-5 px-3">
      <div class="text-center">
      <!-- temp ad -->
      <div class="ad mb-5">
        <div>
          <div class="text-center">
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XJwlOkv1K5GXhAIz" 
            data-ad-width   = "728" 
            data-ad-height  = "90"></ins>
          </div>
        </div>
        <div id="ads-left">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-nsfEeS2PlFxohWoX" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
        <div id="ads-right">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XoJlI1MzVRSxM5dr" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
      </div>
      
      <div class="pt-5">
        <button type="button" class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#help" id="helpbtn">도움말</button>
        <div id="drop-area">
          <form class="my-form">
            <p>사진들을 드래그해서 선택할 수도 있어요</p>
            <input type="file" id="fileElem" multiple accept="image/*" onchange="handleFiles(this.files)">
            <label class="btn btn-outline-light btn-lg" for="fileElem">사진 선택</label>
          </form>
          <progress id="progress-bar" max=100 value=0></progress>
          <div id="gallery"></div>
        </div>
        <button type="button" class="btn btn-outline-light btn-lg" id="matchstart">인식 시작</button>
        <br>
        <br>
        <span id="matchstatus" style="display: none;">상태 : </span><span id="matchwhich"></span><span id="matchingment"></span>
        <div id="matchfinish" style="display: none;">
          <br><span>인게임 카드 보관함에있는 총 카드 개수와 똑같습니까?</span><br><br>
          <br><span id="test"></span><br><br>
          <button type="button" class="btn btn-outline-success btn-lg" id="finishyes">네</button>
          <button type="button" class="btn btn-outline-danger btn-lg" id="finishno">아니요</button>
        </div>

      </div>
    </main>

    <!-- tempAd -->
    <footer class="mt-5 text-white-50">
      <div class="p-0 m-0 mb-2 text-center">
        <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
        data-ad-unit    = "DAN-wTnO0MIIPOzE9w0o" 
        data-ad-width   = "728" 
        data-ad-height  = "90"></ins> 
      </div>
      
      <!-- AdSense -->
      <div class="ADsense">
        <!-- loa_market_chart -->
        <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4936470262963011"
        data-ad-slot="8129420230"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <p>Cover template for <a href="https://getbootstrap.com/" class="text-white">Bootstrap</a>, by <a href="https://twitter.com/mdo" class="text-white">@mdo</a>.</p>
    </footer>
  </div>

  <script>
    document.querySelector('#helpbtn').addEventListener('click', function(){
      var helpimage = document.createElement('img');
      helpimage.src = "img/card1.jpg";
      helpimage.addEventListener('click', function(){window.open("img/card1.jpg");})
      helpimage.style.cursor = "pointer"
      helpimage.style.width = "50%";
      document.querySelector('#modalimg').appendChild(helpimage);
      
      helpimage = document.createElement('img');
      helpimage.src = "img/card2.jpg";
      helpimage.addEventListener('click', function(){window.open("img/card2.jpg");})
      helpimage.style.cursor = "pointer"
      helpimage.style.width = "50%";
      document.querySelector('#modalimg').appendChild(helpimage);

      document.querySelector('#helpbtn').removeEventListener('click', arguments.callee);
    }, false);

    document.querySelector('#finishyes').addEventListener('click', (function(){
      document.querySelector('#matchfinish').style.display = 'none';
      document.querySelector('#matchstatus').style.display = '';
      //document.querySelector('#matchingment').textContent = '도감작 계산중...';
      document.querySelector('#matchingment').textContent = '여기까지 테스트';

      //도감 계산
    }), false)

    document.querySelector('#finishno').addEventListener('click', (function(){
      alert('조건에 맞춰 다시 해주시거나 그래도 안되시면 sjssj7777@naver.com로 인식하기로 한 사진을 보내주세요')
    }), false)


    // ************************ Drag and drop ***************** //
    let dropArea = document.getElementById("drop-area")

    // Prevent default drag behaviors
    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false)   
      document.body.addEventListener(eventName, preventDefaults, false)
    })

    // Highlight drop area when item is dragged over it
    ;['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false)
    })

    ;['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false)
    })

    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false)

    document.querySelector('#matchstart').addEventListener('click', gomatching, false)
    
    function gomatching(){
      if(document.querySelectorAll('#gallery > img').length == 0){
        alert('사진을 선택해주세요')
        return
      }
      this.style.display="none";
      document.querySelector('#drop-area').style.display="none";
      document.querySelector('#matchstatus').style.display = '';

      var head = document.querySelector('head');
      var opencvscript = document.createElement('script');
      var cardlistscript = document.createElement('script');
      opencvscript.type = 'text/javascript';
      cardlistscript.type = 'text/javascript';
      opencvscript.defer = true;
      cardlistscript.defer = true;
      opencvscript.src = 'js/opencv.js';
      cardlistscript.src = 'js/cardlist.js';
      head.appendChild(opencvscript);
      head.appendChild(cardlistscript);
      document.querySelector('#matchingment').textContent = '필요 작업 진행중...(환경에 따라 최대 30초 소요)';
    }

    var Module = {
      async onRuntimeInitialized() { 
        document.querySelector('#matchingment').textContent='카드 인식 시작';
        var cavasimage;
        var canvas;
        var cardremoveimage = new Image();
        cardremoveimage.src = cardremovebase64;
        await new Promise(r => {
          cardremoveimage.onload = r
        })
        var cardremove = cv.imread(cardremoveimage);
        var carddeck = {};
        var screenimg = document.querySelectorAll('#gallery > img');
        let mask;
        var method = cv.TM_CCOEFF_NORMED;;
        let result_cols;
        let result_rows;
        var result;
        let minMaxLoc;
        let matchLoc;
        var cardremovex;
        var cardremovey;
        var startX;
        var startY;
        let template;
        var templateimage;
        let dst;
        let rect;
        document.querySelector('#matchingment').textContent='';
        for (var m = 0; m < screenimg.length; m++) {
          document.querySelector('#matchwhich').textContent=`${m+1}번째 스크린샷 인식중, `;
          cavasimage = new Image();
          cavasimage.src = screenimg[m].src;
          await new Promise(r => {
            cavasimage.onload = r
          })
          
          canvas = cv.imread(cavasimage);
          if(canvas.cols != 1920 || canvas.rows != 1080){
            alert('해상도가 1920 X 1080이 아닙니다.');
            return;
          }

          mask    = new cv.Mat();

          result_cols =   canvas.cols - cardremove.cols + 1;
          result_rows =   canvas.rows - cardremove.rows + 1;

          result = new cv.Mat(result_rows, result_rows, cv.CV_32FC1);

          cv.matchTemplate(canvas, cardremove, result, method, mask);

          cv.normalize(result, result, 0, 1, cv.NORM_MINMAX, -1, new cv.Mat() );

          minMaxLoc   =   cv.minMaxLoc(result);

          if(method == cv.TM_SQDIFF || method == cv.TM_SQDIFF_NORMED){
              matchLoc  = minMaxLoc.minLoc;
          }else{
              matchLoc  = minMaxLoc.maxLoc;
          }

          cardremovex = matchLoc.x;
          cardremovey = matchLoc.y;
          startX = cardremovex - 1101;
          startY = cardremovey + 92;
          
          for (var j = 0; j < 4; j++) {
            y = startY + (j * 182);
            for (var k = 0; k < 10; k++) {
              dst = new cv.Mat();
              mask = new cv.Mat();
              rect = new cv.Rect(0,0,0,0);

              x = startX + (k * 118);
              
              rect = new cv.Rect(x, y, 116, 164);
              source = canvas.roi(rect);

              for (var i = 0; i < Object.keys(cardlist).length; i++) {
                templateimage = new Image();
                templateimage.src = Object.keys(cardlist)[i];
                await new Promise(r => {
                  templateimage.onload = r
                })
                template = cv.imread(templateimage);

                result_cols =   source.cols - template.cols + 1;
                result_rows =   source.rows - template.rows + 1;

                result      =   new cv.Mat(result_rows, result_rows, cv.CV_32FC1);

                cv.matchTemplate(source, template, result, method, mask);

                cv.normalize(result, result, 0, 1, cv.NORM_MINMAX, -1, new cv.Mat() );

                minMaxLoc   =   cv.minMaxLoc(result);

                if(method == cv.TM_SQDIFF || method == cv.TM_SQDIFF_NORMED){
                    matchLoc  = minMaxLoc.minLoc;
                }else{
                    matchLoc  = minMaxLoc.maxLoc;
                }

                if(matchLoc.x == 38 && matchLoc.y == 38){
                  //솔 그랑데, 지휘관 솔 이미지 똑같아서 조건 추가
                  if(cardlist[Object.keys(cardlist)[i]] == '솔 그랑데' && source.ucharAt(21, 41 * source.channels() + 2) < 130){
                    continue;
                  }
                  //기드온, 투란 오인식
                  if(cardlist[Object.keys(cardlist)[i]] == '기드온' && source.ucharAt(61, 32 * source.channels()) < 150){
                    continue;
                  }
                  //비아키스, 레나 오인식
                  if(cardlist[Object.keys(cardlist)[i]] == '비아키스' && source.ucharAt(43, 30 * source.channels() + 2) > 90){
                    continue;
                  }
                  //레퓌스, 난민 파밀리아 오인식
                  if(cardlist[Object.keys(cardlist)[i]] == '레퓌스' && source.ucharAt(73, 34 * source.channels()) > 170){
                    continue;
                  }

                  for (var l = 5; l > 0; l--) {
                    if(source.ucharAt(135, (91 - (Math.abs(l-5) * 15)) * source.channels()) > 150){
                      carddeck[cardlist[Object.keys(cardlist)[i]]] = l;
                      l=0;
                    }else if(l==1){
                      carddeck[cardlist[Object.keys(cardlist)[i]]] = 0;
                    }
                  }
                  document.querySelector('#matchingment').textContent=`인식된 카드 ${Object.keys(carddeck).length}장`;

                  delete cardlist[Object.keys(cardlist)[i]];

                  i=Object.keys(cardlist).length;
                }
                template.delete();result.delete();
              }
              source.delete();mask.delete();
            }
          }
        }
        canvas.delete(),cardremove.delete();
        document.querySelector('#matchwhich').textContent=``;
        document.querySelector('#matchstatus').style.display = 'none';
        document.querySelector('#matchingment').textContent=`인식된 총 카드 ${Object.keys(carddeck).length}장`;
        document.querySelector('#test').textContent=`${JSON.stringify(carddeck)}`;
        console.log(carddeck);
        console.log(Object.keys(carddeck).length);
        document.querySelector('#matchfinish').style.display = "";
      }
    }


    function preventDefaults (e) {
      e.preventDefault()
      e.stopPropagation()
    }

    function highlight(e) {
      dropArea.classList.add('highlight')
    }

    function unhighlight(e) {
      dropArea.classList.remove('active')
    }

    function handleDrop(e) {
      var dt = e.dataTransfer
      var files = dt.files

      handleFiles(files)
    }

    let uploadProgress = []
    let progressBar = document.getElementById('progress-bar')

    function initializeProgress(numFiles) {
      progressBar.value = 0
      uploadProgress = []

      for(let i = numFiles; i > 0; i--) {
        uploadProgress.push(0)
      }
    }

    function updateProgress(fileNumber, percent) {
      uploadProgress[fileNumber] = percent
      let total = uploadProgress.reduce((tot, curr) => tot + curr, 0) / uploadProgress.length
      progressBar.value = total
    }

    function handleFiles(files) {
      files = [...files]
      files.sort(function(a,b){
        var textA = a.name.toLowerCase();
        var textB = b.name.toLowerCase();
        return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
      })
      initializeProgress(files.length)
      files.forEach(previewFile)
    }

    function previewFile(file) {
      let reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onloadend = async function() {
        let img = document.createElement('img');
        img.src = reader.result;
        document.getElementById('gallery').appendChild(img);
      }
    }

    function uploadFile(file, i) {
      var formData = new FormData()
      xhr.open('POST', url, true)
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')

      // Update progress (can be used to show progress indicator)
      xhr.upload.addEventListener("progress", function(e) {
        updateProgress(i, (e.loaded * 100.0 / e.total) || 100)
      })

      xhr.addEventListener('readystatechange', function(e) {
        if (xhr.readyState == 4 && xhr.status == 200) {
          updateProgress(i, 100) // <- Add this
        }
        else if (xhr.readyState == 4 && xhr.status != 200) {
          // Error. Inform the user
        }
      })
      
      formData.append('upload_preset', 'ujpu6gyk')
      formData.append('file', file)
      xhr.send(formData)
    }
  </script>
  <div class="modal fade bd-example-modal-lg" id="help" tabindex="-1" aria-labelledby="helpLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-black">도움말</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-black">
          <p>옛날에 한정으로 뿌린(미녀 삼총사, 그땐 그랬지 세트) 카드들은<br>제가 가진게 없어서 사진을 등록하지 못했습니다. <br>제외하고 테스트해주시길 바랍니다.
          <br>혹시나 저 위에 카드들을 가지고 계신분은 sjssj7777@naver.com으로<br>필수 조건에 맞게 찍은 스크린샷 보내주시면 감사하겠습니다.</p>
          <h3>※ 필수 ※</h3>
          <p>1. 1920 X 1080 해상도</p>
          <p>2. 인게임 스크린샷 기능으로 찍은 사진</p>
          <h3>※ 권장 ※</h3>
          <span>오래걸림(권장사항 지키면 인식 30초도 안되서 끝남), 오인식 방지</span><br><br>
          <p>1. 순서대로(전설카드 -> 일반카드)</p>
          <p>2. 각 사진마다 중복없이</p>
          <p>예) 첫번째 사진에서 마지막 카드 '반다' 까지 찍혔으면<br>그 바로 밑에줄인 '베르투스'부터 시작해서 끝까지 찍기 반복</p>
          <p id="modalimg">
          </p>
          <h3>※ 사용방법 ※</h3>
          <p>1. 카드 보관함을 찍은 사진들을 선택</p>
          <p>2. '인식 시작' 클릭</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn btn-outline-dark text-black" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>