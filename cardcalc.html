<!DOCTYPE html>
<html lang="ko">
<head class="h-100">
  <title>도감작 계산기 :: LoChart</title>
  <meta name="description" content="로스트아크 도감작 계산기">
  <script>var here = "cardcalc";</script>
  
  <script src="https://unpkg.com/@popperjs/core@2.11.5/dist/umd/popper.min.js"></script>
  <script src="https://unpkg.com/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script>

  <!-- jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="js/jquery.cookie-1.4.1.min.js" > </script>

  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

  <!-- custom -->
  <script src="js/custom.js"></script>
  <link rel="stylesheet" type="text/css" href="css/custom.css">

  <!-- google ADSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4936470262963011"
     crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/ubhor-phi@latest/dist/script.min.js"></script>
  <meta name="adshield-analytics-verification" content="d7b8eb3d-f8fa-41ae-9794-c05e2ed4deb8"/>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XD44D79GLY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XD44D79GLY');
  </script>

  <style>
    @media (max-width: 992px) {
      .w-50 {
        width: 100%!important;
      }
    }
    body {
      font-family: sans-serif;
    }
    a {
      color: #369;
    }
    .note {
      width: 500px;
      margin: 50px auto;
      font-size: 1.1em;
      color: #333;
      text-align: justify;
    }
    #drop-area {
      border: 2px dashed #ccc;
      border-radius: 20px;
      width: 90%;
      margin: 50px auto;
      padding: 20px;
    }
    #drop-area.highlight {
      border-color: purple;
    }
    p {
      margin-top: 0;
    }
    .my-form {
      margin-bottom: 10px;
    }
    #gallery {
      margin-top: 10px;
    }
    #gallery img {
      width: 48%;
      margin-bottom: 10px;
      margin-right: 10px;
      vertical-align: middle;
    }
    #fileElem {
      display: none;
    }
    .tippy-box[data-theme~='light'] {
      background-color: rgb(255, 255, 255);
      color: rgb(0, 0, 0);
    }
  </style>
  <link href="css/cover.css" rel="stylesheet">
</head>

<body class="d-flex h-100 text-center text-white bg-dark">
  <div class="container d-flex w-100 h-100 p-3 mx-auto flex-column">

    <header class="mb-3">
      <div>
        <a href="/"><h3 class="float-md-start mb-0 text-white">LoChart</h3></a>
        <nav class="nav nav-masthead justify-content-center float-md-end"></nav>
      </div>
    </header>

    <main class="pt-5 pb-5 px-3">
      <div class="text-center">
      <!-- temp ad -->
      <div class="ad mb-5">
        <div>
          <div class="text-center">
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XJwlOkv1K5GXhAIz" 
            data-ad-width   = "728" 
            data-ad-height  = "90"></ins>
          </div>
        </div>
        <div id="ads-left">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-nsfEeS2PlFxohWoX" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
        <div id="ads-right">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XoJlI1MzVRSxM5dr" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
      </div>
      
      <div class="pt-5">
        <div id="matchzone">
          <button type="button" class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#help" id="helpbtn">도움말</button>
          <div id="drop-area">
            <form class="my-form">
              <p>사진들을 드래그해서 선택할 수도 있어요</p>
              <input type="file" id="fileElem" multiple accept="image/*" onchange="handleFiles(this.files)">
              <label class="btn btn-outline-light btn-lg" for="fileElem">사진 선택</label>
            </form>
            <progress id="progress-bar" max=100 value=0></progress>
            <div id="gallery"></div>
          </div>
          <button type="button" class="btn btn-outline-light btn-lg" id="matchstart">인식 시작</button>
          <br>
          <br>
          <span id="matchstatus" style="display: none;">상태 : </span><span id="matchwhich"></span><span id="matchingment"></span>
          <p id="searchingcardlist"></p>
          <div id="matchfinish" style="display: none;">
            <span>인게임 카드 보관함에있는 총 카드 개수와 똑같습니까?</span><br>
            <button type="button" class="btn btn-outline-success btn-lg" id="finishyes">네</button>
            <button type="button" class="btn btn-outline-danger btn-lg" id="finishno">아니요</button>
          </div>
        </div>

        <div id="mycard" style="display: none;">
          <div class="clearfix container">
            <div class="row">
              <div id="bookeffect" class="col-5">
                　
                <table class="table table-dark float-start table-hover">
                  <thead>
                    <tr>
                      <th scope="col" colspan="2">현재
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle-fill" viewBox="0 0 16 16" data-bs-toggle="tooltip" data-bs-placement="right" title="과거에 카드 삭제한번이라도 했으면 오차 있을수 있음(카드 삭제를 해도 도감에서는 수집 유무로 효과가 올라가기 때문)">
                          <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z"/>
                        </svg>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  <tbody>
                    <tr>
                      <td>힘</td>
                      <td id="힘"></td>
                    </tr>
                    <tr>
                      <td>민첩</td>
                      <td id="힘"></td>
                    </tr>
                    <tr>
                      <td>지능</td>
                      <td id="힘"></td>
                    </tr>
                    <tr>
                      <td>체력</td>
                      <td id="체력"></td>
                    </tr>
                    <tr>
                      <td>치명</td>
                      <td id="치명"></td>
                    </tr>
                    <tr>
                      <td>특화</td>
                      <td id="특화"></td>
                    </tr>
                    <tr>
                      <td>제압</td>
                      <td id="제압"></td>
                    </tr>
                    <tr>
                      <td>신속</td>
                      <td id="신속"></td>
                    </tr>
                    <tr>
                      <td>인내</td>
                      <td id="인내"></td>
                    </tr>
                    <tr>
                      <td>숙련</td>
                      <td id="숙련"></td>
                    </tr>
                    <tr>
                      <td>물리 방어력</td>
                      <td id="방어력"></td>
                    </tr>
                    <tr>
                      <td>마법 방어력</td>
                      <td id="방어력"></td>
                    </tr>
                    <tr>
                      <td>인간 계열 피해량 증가</td>
                      <td id="인간"></td>
                    </tr>
                    <tr>
                      <td>악마 계열 피해량 증가</td>
                      <td id="악마"></td>
                    </tr>
                    <tr>
                      <td>물질 계열 피해량 증가</td>
                      <td id="물질"></td>
                    </tr>
                    <tr>
                      <td>불사 계열 피해량 증가</td>
                      <td id="불사"></td>
                    </tr>
                    <tr>
                      <td>식물 계열 피해량 증가</td>
                      <td id="식물"></td>
                    </tr>
                    <tr>
                      <td>곤충 계열 피해량 증가</td>
                      <td id="곤충"></td>
                    </tr>
                    <tr>
                      <td>정령 계열 피해량 증가</td>
                      <td id="정령"></td>
                    </tr>
                    <tr>
                      <td>야수 계열 피해량 증가</td>
                      <td id="야수"></td>
                    </tr>
                    <tr>
                      <td>기계 계열 피해량 증가</td>
                      <td id="기계"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="col-7">
                <div id="bonusdamageBtns">
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">악마</button>
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">야수</button>
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">정령</button>
                  <br>
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">불사</button>
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">물질</button>
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">인간</button>
                  <br>
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">식물</button>
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">기계</button>
                  <button type="button" class="btn btn-outline-light btn-lg mb-1">곤충</button>
                </div>
                <p class="mt-2">각 도감 수치에 커서를 올리면 다음 각성<br>단계까지 최선의 강화 순서를 표시합니다.</p>
                <table class="table table-dark float-end table-hover col">
                  <thead>
                    <tr>
                      <th scope="col" class="align-middle">도감 이름</th>
                      <th scope="col">다음 각성 단계까지<br>필요한 최소 카드 경험치</th>
                    </tr>
                  </thead>
                  <tbody>
                  <tbody id="bookstbody">
                  </tbody>
                </table>
              </div>
            </div>



          </div>
        </div>

      </div>
    </main>

    <!-- tempAd -->
    <footer class="mt-5 text-white-50">
      <div class="p-0 m-0 mb-2 text-center">
        <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
        data-ad-unit    = "DAN-wTnO0MIIPOzE9w0o" 
        data-ad-width   = "728" 
        data-ad-height  = "90"></ins> 
      </div>
      
      <!-- AdSense -->
      <div class="ADsense">
        <!-- loa_market_chart -->
        <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4936470262963011"
        data-ad-slot="8129420230"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <p>Cover template for <a href="https://getbootstrap.com/" class="text-white">Bootstrap</a>, by <a href="https://twitter.com/mdo" class="text-white">@mdo</a>.</p>
    </footer>
  </div>

  <script>
    var recommendExp;
    var recommendCard;
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    bonusDamageBtns = document.querySelectorAll('#bonusdamageBtns button');
    bonusDamageBtns.forEach(function(e){
      e.addEventListener('click', function(){
        bonusDamageBtns.forEach(function(f){
          if(f.classList.contains('active')){
            f.classList.remove('active');
            return false;
          }
        })
        e.classList.add('active');

        target = document.querySelector('#bookstbody');
        while (target.hasChildNodes()) {
          target.removeChild(target.firstChild);
        }

        try{
          targetLength = recommendExp[this.innerText].length;
        }catch{
          return;
        }

        for (var i = 0; i < targetLength; i++) {
          tr = document.createElement('tr');
          tdsetname = document.createElement('td');
          tdsetexp = document.createElement('td');

          exp = recommendExp[this.innerText][i][Object.keys(recommendExp[this.innerText][i])];
          if(exp == 0) continue;
          
          tdsetname.textContent = Object.keys(recommendExp[this.innerText][i]);
          tdsetexp.textContent = (recommendExp[this.innerText][i][Object.keys(recommendExp[this.innerText][i])]).toLocaleString();

          tdsetexp.addEventListener('mouseover',function(){
            targetSetName = this.parentNode.firstChild.innerText;
            targetTri = "";
            let list;

            document.querySelectorAll('#bonusdamageBtns button').forEach(function(g){
              if(g.classList.contains('active')){
                targetTri = g.innerText;
                return false;
              }
            })
            
            recommendCard[targetTri].forEach(function(g){
              if(Object.keys(g)[0] == targetSetName){
                list = g[Object.keys(g)[0]];
                return false;
              }
            });

            tooltipcontent = ""
            tempdict = {};
            for (var j = 0; j < list.length; j++) {
              if(tempdict[list[j][0]] == undefined) tempdict[list[j][0]] = 0;
              plus = tempdict[list[j][0]];
              plus++;
              tempdict[list[j][0]] = plus; 
            }

            for (var j = 0; j < Object.keys(tempdict).length; j++) {
              tooltipcontent += `${Object.keys(tempdict)[j]} +${tempdict[Object.keys(tempdict)[j]]}강<br>`;
            }

            tippy(this, {
              allowHTML: true, 
              content: tooltipcontent,
              theme: 'light', 
              placement: 'top', 
            });
          })

          tr.append(tdsetname);
          tr.append(tdsetexp);
          target.appendChild(tr);
        }
      })
    });

    var carddeck = {};
    document.querySelector('#helpbtn').addEventListener('click', function(){
      var helpimage = document.createElement('img');
      helpimage.src = "img/card1.jpg";
      helpimage.addEventListener('click', function(){window.open("img/card1.jpg");})
      helpimage.style.cursor = "pointer"
      helpimage.style.width = "50%";
      document.querySelector('#modalimg').appendChild(helpimage);
      
      helpimage = document.createElement('img');
      helpimage.src = "img/card2.jpg";
      helpimage.addEventListener('click', function(){window.open("img/card2.jpg");})
      helpimage.style.cursor = "pointer"
      helpimage.style.width = "50%";
      document.querySelector('#modalimg').appendChild(helpimage);

      helpimage = document.createElement('img');
      helpimage.src = "img/warning.jpg";
      helpimage.addEventListener('click', function(){window.open("img/warning.jpg");})
      helpimage.style.cursor = "pointer"
      helpimage.style.width = "50%";
      document.querySelector('#modalimg2').appendChild(helpimage);

      document.querySelector('#helpbtn').removeEventListener('click', arguments.callee);
    }, false);

    document.querySelector('#finishyes').addEventListener('click', async function(){
      document.querySelector('#matchfinish').style.display = 'none';
      document.querySelector('#matchstatus').style.display = '';

      document.querySelector('#matchingment').textContent = '여기까지 테스트';

      //return;
      document.querySelector('#matchingment').textContent = '필요 작업 진행중...(환경에 따라 최대 30초 소요)';
      var head = document.querySelector('head');
      var cardeffectscript = document.createElement('script');
      cardeffectscript.type = 'text/javascript';
      cardeffectscript.defer = true;
      cardeffectscript.src = 'js/cardeffect.js';
      head.appendChild(cardeffectscript);
      await new Promise(r => {
        cardeffectscript.onload = r
      })

      document.querySelector('#matchingment').textContent = '도감작 계산 시작';
      var stat = {
        "힘"      : 0,
        "체력"    : 0,
        "치명"    : 0,
        "특화"    : 0,
        "제압"    : 0,
        "신속"    : 0,
        "인내"    : 0,
        "숙련"    : 0,
        "방어력"  : 0,
      }
      var bonusDamage = {
        "인간" : 0,
        "악마" : 0,
        "물질" : 0,
        "불사" : 0,
        "식물" : 0,
        "곤충" : 0,
        "정령" : 0,
        "야수" : 0,
        "기계" : 0
      };

      var cardeffectlength = Object.keys(cardeffect).length;

      var setname;
      var set;
      var setcardlist;
      var bonus;
      var level;
      var leveltotal;
      var nextbonus;
      var nextlevels;
      var nextLevelExp;
      var nextUpSetLevel;
      recommendExp = {};
      recommendCard = {};
      for (var i = 0; i < cardeffectlength; i++) {
        leveltotal = 0;
        nextlevels = [];
        nextLevelExp = 0;
        nextUpSetLevel = [];
        setname = Object.keys(cardeffect)[i];
        document.querySelector('#matchingment').textContent = `(${i+1} / ${cardeffectlength}) [${setname}] 진행중`;
        set = cardeffect[Object.keys(cardeffect)[i]];
        setcardlist = set[0];
        
        for (var j = 0; j < setcardlist.length; j++) {
          level = carddeck[setcardlist[j]];
          if(level == undefined){
            break;
          }
          leveltotal += level;

          for (var k = 4; k > -1+level; k--) {
            nextlevels.push([setcardlist[j],cardLevelUpExp[cardgrade[setcardlist[j]]][k]])
          }
        }
        if(j != setcardlist.length){
          continue;
        }
        
        nextlevels.sort(function(a,b){
          return a[1] - b[1];
        })

        stat[set[1]] += set[2];

        for (var j = 0; j < Object.keys(set[4]).length; j++) {
          if(Object.keys(set[4])[j] <= leveltotal){
            bonusDamage[set[3]] += set[4][Object.keys(set[4])[j]];
          }else{
            nextbonusdamage = set[4][Object.keys(set[4])[j]];
            nextleveldif = Object.keys(set[4])[j] - leveltotal;
            for (var k = 0; k < nextleveldif; k++) {
              nextLevelExp += nextlevels[k][1];
              nextUpSetLevel.push(nextlevels[k]);
            }
            break;
          }
        }

        try{
          recommendCard[set[3]].push({[setname]:nextUpSetLevel});
          recommendExp[set[3]].push({[setname]:nextLevelExp});
        }catch{
          recommendCard[set[3]] = [{[setname]:nextUpSetLevel}];
          recommendExp[set[3]] = [({[setname]:nextLevelExp})];
        }
      }
      //카드 삭제한번이라도 했으면 오차 있을수 있음
      document.querySelector('#matchingment').textContent = `계산 완료(임시로 콘솔창에서 확인)`;

      for (var i = 0; i < Object.keys(recommendExp).length; i++) {
        recommendExp[Object.keys(recommendExp)[i]].sort(function(a,b){
          return a[Object.keys(a)[0]] - b[Object.keys(b)[0]];
        })
      }

      //console.log('과거에 카드 삭제한번이라도 했으면 오차 있을수 있음(카드 삭제를 해도 도감에서는 수집 유무로 효과가 올라가기 때문에)');
      //console.log('권장강화카드');
      //console.log(recommendCard);
      //console.log('권장강화카드에 필요한 카드경험치');
      //console.log(recommendExp);
      //console.log(stat)
      //console.log(bonusDamage);

      
      for (var i = 0; i < Object.keys(stat).length; i++) {
        document.querySelectorAll('#'+Object.keys(stat)[i]).forEach(e => {
          e.textContent = stat[Object.keys(stat)[i]];
        });
      }
      for (var i = 0; i < Object.keys(bonusDamage).length; i++) {
        document.querySelectorAll('#'+Object.keys(bonusDamage)[i]).forEach(e => {
          e.textContent = bonusDamage[Object.keys(bonusDamage)[i]].toFixed(2) + "%";
        });
      }

      document.querySelector('#matchzone').style.display="none";
      document.querySelector('#mycard').style.display="";
      
    }, false)

    document.querySelector('#finishno').addEventListener('click', function(){
      alert('조건에 맞춰 다시 해주시거나 그래도 안되시면 sjssj7777@naver.com로 인식하기로 한 사진을 보내주세요')
    }, false)

    // ************************ Drag and drop ***************** //
    let dropArea = document.getElementById("drop-area")

    // Prevent default drag behaviors
    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false)   
      document.body.addEventListener(eventName, preventDefaults, false)
    })

    // Highlight drop area when item is dragged over it
    ;['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false)
    })

    ;['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false)
    })

    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false)

    document.querySelector('#matchstart').addEventListener('click', gomatching, false)
    
    function gomatching(){
      if(document.querySelectorAll('#gallery > img').length == 0){
        alert('사진을 선택해주세요')
        return
      }
      this.style.display="none";
      document.querySelector('#drop-area').style.display="none";
      document.querySelector('#helpbtn').style.display = 'none';
      document.querySelector('#matchstatus').style.display = '';
      

      var head = document.querySelector('head');
      var opencvscript = document.createElement('script');
      var cardlistscript = document.createElement('script');
      opencvscript.type = 'text/javascript';
      cardlistscript.type = 'text/javascript';
      opencvscript.defer = true;
      cardlistscript.defer = true;
      opencvscript.src = 'js/opencv.js';
      cardlistscript.src = 'js/cardlist.js';
      head.appendChild(opencvscript);
      head.appendChild(cardlistscript);
      document.querySelector('#matchingment').textContent = '필요 작업 진행중...(환경에 따라 최대 30초 소요)';
    }

    var Module = {
      async onRuntimeInitialized() { 
        document.querySelector('#matchingment').textContent='카드 인식 시작';
        var cavasimage;
        var canvas;
        var cardremoveimage = new Image();
        cardremoveimage.src = cardremovebase64;
        await new Promise(r => {
          cardremoveimage.onload = r
        })
        var cardremove = cv.imread(cardremoveimage);
        var screenimg = document.querySelectorAll('#gallery > img');
        let mask;
        var method = cv.TM_CCOEFF_NORMED;;
        let result_cols;
        let result_rows;
        var result;
        let minMaxLoc;
        let matchLoc;
        var cardremovex;
        var cardremovey;
        var startX;
        var startY;
        let template;
        var templateimage;
        let dst;
        let rect;
        document.querySelector('#matchingment').textContent='';
        for (var m = 0; m < screenimg.length; m++) {
          thispagecardlist = [];
          document.querySelector('#matchwhich').textContent=`${m+1}번째 스크린샷 인식중, `;
          cavasimage = new Image();
          cavasimage.src = screenimg[m].src;
          await new Promise(r => {
            cavasimage.onload = r
          })
          
          canvas = cv.imread(cavasimage);
          if(canvas.cols != 1920 || canvas.rows != 1080){
            alert('해상도가 1920 X 1080이 아닙니다.');
            return;
          }

          mask    = new cv.Mat();

          result_cols =   canvas.cols - cardremove.cols + 1;
          result_rows =   canvas.rows - cardremove.rows + 1;

          result = new cv.Mat(result_rows, result_rows, cv.CV_32FC1);

          cv.matchTemplate(canvas, cardremove, result, method, mask);

          cv.normalize(result, result, 0, 1, cv.NORM_MINMAX, -1, new cv.Mat() );

          minMaxLoc   =   cv.minMaxLoc(result);

          if(method == cv.TM_SQDIFF || method == cv.TM_SQDIFF_NORMED){
              matchLoc  = minMaxLoc.minLoc;
          }else{
              matchLoc  = minMaxLoc.maxLoc;
          }

          cardremovex = matchLoc.x;
          cardremovey = matchLoc.y;
          startX = cardremovex - 1101;
          startY = cardremovey + 92;
          
          for (var j = 0; j < 4; j++) {
            y = startY + (j * 182);
            for (var k = 0; k < 10; k++) {
              dst = new cv.Mat();
              mask = new cv.Mat();
              rect = new cv.Rect(0,0,0,0);

              x = startX + (k * 118);
              
              rect = new cv.Rect(x, y, 116, 164);
              source = canvas.roi(rect);

              for (var i = 0; i < Object.keys(cardlist).length; i++) {
                templateimage = new Image();
                templateimage.src = Object.keys(cardlist)[i];
                await new Promise(r => {
                  templateimage.onload = r
                })
                template = cv.imread(templateimage);

                result_cols =   source.cols - template.cols + 1;
                result_rows =   source.rows - template.rows + 1;

                result      =   new cv.Mat(result_rows, result_rows, cv.CV_32FC1);

                cv.matchTemplate(source, template, result, method, mask);

                cv.normalize(result, result, 0, 1, cv.NORM_MINMAX, -1, new cv.Mat() );

                minMaxLoc   =   cv.minMaxLoc(result);

                if(method == cv.TM_SQDIFF || method == cv.TM_SQDIFF_NORMED){
                    matchLoc  = minMaxLoc.minLoc;
                }else{
                    matchLoc  = minMaxLoc.maxLoc;
                }

                if(matchLoc.x == 38 && matchLoc.y == 38){
                  //솔 그랑데, 지휘관 솔 이미지 똑같아서 조건 추가
                  if(cardlist[Object.keys(cardlist)[i]] == '솔 그랑데' && source.ucharAt(21, 41 * source.channels() + 2) < 130){
                    continue;
                  }
                  //기드온, 투란 오인식
                  if(cardlist[Object.keys(cardlist)[i]] == '기드온' && source.ucharAt(61, 32 * source.channels()) < 150){
                    continue;
                  }
                  //비아키스, 레나 오인식
                  if(cardlist[Object.keys(cardlist)[i]] == '비아키스' && source.ucharAt(43, 30 * source.channels() + 2) > 90){
                    continue;
                  }
                  //레퓌스, 난민 파밀리아 오인식
                  if(cardlist[Object.keys(cardlist)[i]] == '레퓌스' && source.ucharAt(73, 34 * source.channels()) > 170){
                    continue;
                  }
                  //사일러스, 하눈 오인식
                  if(cardlist[Object.keys(cardlist)[i]] == '사일러스' && source.ucharAt(42, 28 * source.channels()) > 50){
                    continue;
                  }
                  //하누마탄, 한이 서린 여인 오인식
                  if(cardlist[Object.keys(cardlist)[i]] == '하누마탄' && source.ucharAt(50, 54 * source.channels()) < 200){
                    continue;
                  }

                  for (var l = 5; l > 0; l--) {
                    if(source.ucharAt(135, (91 - (Math.abs(l-5) * 15)) * source.channels()) > 150){
                      carddeck[cardlist[Object.keys(cardlist)[i]]] = l;
                      l=0;
                    }else if(l==1){
                      carddeck[cardlist[Object.keys(cardlist)[i]]] = 0;
                    }
                  }
                  thispagecardlist.push(cardlist[Object.keys(cardlist)[i]]);
                  document.querySelector('#matchingment').textContent=`인식된 카드 ${Object.keys(carddeck).length}장`;

                  delete cardlist[Object.keys(cardlist)[i]];

                  i=Object.keys(cardlist).length;
                }
                template.delete();result.delete();
              }
              source.delete();mask.delete();
            }
          }
          document.querySelector('#searchingcardlist').innerHTML += `<br><br>${m+1}페이지(${thispagecardlist.length}) : ${thispagecardlist}`;
        }
        canvas.delete(),cardremove.delete();  
        document.querySelector('#matchwhich').textContent=``;
        document.querySelector('#matchstatus').style.display = 'none';
        document.querySelector('#matchingment').textContent=`인식된 총 카드 ${Object.keys(carddeck).length}장`;
        document.querySelector('#matchfinish').style.display = "";
      }
    }


    function preventDefaults (e) {
      e.preventDefault()
      e.stopPropagation()
    }

    function highlight(e) {
      dropArea.classList.add('highlight')
    }

    function unhighlight(e) {
      dropArea.classList.remove('active')
    }

    function handleDrop(e) {
      var dt = e.dataTransfer
      var files = dt.files

      handleFiles(files)
    }

    let uploadProgress = []
    let progressBar = document.getElementById('progress-bar')

    function initializeProgress(numFiles) {
      progressBar.value = 0
      uploadProgress = []

      for(let i = numFiles; i > 0; i--) {
        uploadProgress.push(0)
      }
    }

    function updateProgress(fileNumber, percent) {
      uploadProgress[fileNumber] = percent
      let total = uploadProgress.reduce((tot, curr) => tot + curr, 0) / uploadProgress.length
      progressBar.value = total
    }

    function handleFiles(files) {
      files = [...files]
      files.sort(function(a,b){
        var textA = a.name.toLowerCase();
        var textB = b.name.toLowerCase();
        return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
      })
      initializeProgress(files.length)
      files.forEach(previewFile)
    }

    function previewFile(file) {
      let reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onloadend = async function() {
        let img = document.createElement('img');
        img.src = reader.result;
        document.getElementById('gallery').appendChild(img);
      }
    }

    function uploadFile(file, i) {
      var formData = new FormData()
      xhr.open('POST', url, true)
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')

      // Update progress (can be used to show progress indicator)
      xhr.upload.addEventListener("progress", function(e) {
        updateProgress(i, (e.loaded * 100.0 / e.total) || 100)
      })

      xhr.addEventListener('readystatechange', function(e) {
        if (xhr.readyState == 4 && xhr.status == 200) {
          updateProgress(i, 100) // <- Add this
        }
        else if (xhr.readyState == 4 && xhr.status != 200) {
          // Error. Inform the user
        }
      })
      
      formData.append('upload_preset', 'ujpu6gyk')
      formData.append('file', file)
      xhr.send(formData)
    }
  </script>
  <div class="modal fade bd-example-modal-lg" id="help" tabindex="-1" aria-labelledby="helpLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-black">도움말</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-black">
          <h3>※ 필수 ※</h3>
          <p>1. 1920 X 1080 해상도</p>
          <p>2. 인게임 스크린샷 기능으로 찍은 사진</p>
          <h3>※ 권장 ※</h3>
          <span>아래 사항 지킬시 30초도 안되서 끝, 오인식 방지를 위해</span><br>
          <p>1. 스크린샷 찍은 순서대로(전설카드 -> 일반카드)넣어주세요.</p>
          <p>2. 각 사진마다 중복없이</p>
          <p>예) 첫번째 사진에서 마지막 카드 '반다' 까지 찍혔으면<br>그 바로 밑에줄인 '베르투스'부터 시작해서 끝까지 찍기 반복</p>
          <p id="modalimg"></p>
          </p>
          <h3>※ 사용방법 ※</h3>
          <p>1. 카드 보관함을 찍은 사진들을 선택</p>
          <p>2. '인식 시작' 클릭</p>
          <h3>※ 주의사항 ※</h3>
          <p>1. 노란 영역안에 아무것도 없어야 합니다.(강화 전광판X, 친구 접속 안내문구X)</p>
          <p id="modalimg2"></p>
          <br>
          <p>이미지를 클릭하면 크게 볼 수 있습니다.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn btn-outline-dark text-black" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>