<!DOCTYPE html>
<html lang="ko">
<head class="h-100">
  <title>제작 :: LoChart</title>
  <script>var here = "craftcalc";</script>

  <!-- toastify -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <!-- jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="js/jquery.cookie-1.4.1.min.js" > </script>

  <!-- bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <!-- bootstrap-table -->
  <script src="https://unpkg.com/bootstrap-table/dist/bootstrap-table.min.js"></script>
  <link href="css/fresh-bootstrap-table.css" rel="stylesheet" />

  <!-- custom -->
  <script src="js/custom.js"></script>
  <link rel="stylesheet" type="text/css" href="css/custom.css">


  <!-- google ADSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4936470262963011"
     crossorigin="anonymous"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XD44D79GLY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XD44D79GLY');
  </script>

  <link href="css/cover.css" rel="stylesheet">
</head>

<body class="d-flex h-100 text-center text-white bg-dark">    
  <div class="container d-flex w-100 h-100 p-3 mx-auto flex-column">

    <header class="mb-3">
      <div>
        <a href="/"><h3 class="float-md-start mb-0 text-white">LoChart</h3></a>
        <nav class="nav nav-masthead justify-content-center float-md-end">
        </nav>
      </div>
    </header>

    <main class="pt-5 pb-5 px-3">
      <div class="text-center">

      <!-- temp ad -->
      <div class="ad mb-5">
        <div>
          <div class="text-center">
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XJwlOkv1K5GXhAIz" 
            data-ad-width   = "728" 
            data-ad-height  = "90"></ins>
          </div>
        </div>
        <div id="ads-left">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-nsfEeS2PlFxohWoX" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
        <div id="ads-right">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XoJlI1MzVRSxM5dr" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
      </div>
      
      <div class="mx-auto w-100 pt-5 pb-5">
        <div class="fresh-table full-color-custom">
          <div class="toolbar text-start">
            <button id="alertBtn" class="btn btn-default" data-bs-toggle="collapse" data-bs-target="#collapse">영지 효과</button>
            <div class="accordion" style="width: 584px;">
              <div id="collapse" class="accor dion-collapse collapse" aria-labelledby="heading" data-bs-parent="#accordion">
                <div class="accordion-body p-0">
                  <table class="table mt-3 table-hover mb-3 text-center">
                    <thead>
                      <tr>
                        <th scope="col">전체</th>
                        <th scope="col">배틀아이템</th>
                        <th scope="col">요리</th>
                        <th scope="col">특수</th>
                      </tr>
                    </thead>
                    <tbody class="align-middle" id="wisdomeffect">
                      <tr>
                        <td colspan="5">대성공 확률</td>
                      </tr>
                      <tr>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="gs_all" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="gs_b" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="gs_c" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="gs_s" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                      </tr>
                      <tr>
                        <td colspan="5">제작 수수료 감소율</td>
                      </tr>
                      <tr>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="cc_all" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="cc_b" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="cc_c" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="cc_s" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                      </tr>
                      <tr>
                        <td colspan="5">활동력 감소율</td>
                      </tr>
                      <tr>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="e_all" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="e_b" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="e_c" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="e_s" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="text-center">
                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#MA">도움말</button>
                  <button id="wisdomedit" class="btn btn-default" data-bs-toggle="collapse" data-bs-target="#collapse">수정</button>
                </div>
              </div>
            </div>
          </div>
          <table id="fresh-table" 
                 class="table"
                 data-detail-view="true"
                 data-detail-view-icon="false"
                 data-detail-view-by-click="true"
                 data-detail-formatter="detailFormatter">
            <thead>
              <th data-field="image" data-formatter="imageFormatter"></th>
              <th class="text-start" data-field="item" data-sortable="true">아이템</th>
              <th data-field="recommend" data-sortable="true" data-cell-style="recomcellStyle">추천방식</th>
              <th data-field="buyprice" data-sortable="true">시세</th>
              <th data-field="craftprice" data-sortable="true">제작비용</th>
              <th data-field="profit" data-sortable="true" data-cell-style="profcellStyle">판매이익</th>
              <th data-field="profitperenergy" data-sortable="true">이익/활동력</th>
            </thead>
            <tbody style="cursor:pointer"></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- tempAd -->
    <footer class="mt-5 text-white-50">
      <div class="p-0 m-0 mb-2 text-center">
        <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
        data-ad-unit    = "DAN-wTnO0MIIPOzE9w0o" 
        data-ad-width   = "728" 
        data-ad-height  = "90"></ins> 
      </div>
      
      <!-- AdSense -->
      <div class="ADsense">
        <!-- loa_market_chart -->
        <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4936470262963011"
        data-ad-slot="8129420230"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <p>Cover template for <a href="https://getbootstrap.com/" class="text-white">Bootstrap</a>, by <a href="https://twitter.com/mdo" class="text-white">@mdo</a>.</p>
    </footer>
  </div>
  <style>
    .fresh-table .bootstrap-table .table thead > tr > th:first-child {
      padding-left: 0px !important;
    }
    .bootstrap-table .fixed-table-container .table thead th .sortable {
      padding-right: 0.75rem !important;
    }
    .fresh-table .bootstrap-table .table > thead > tr > th{
      padding: 0px !important;
      font-size: var(--bs-body-font-size) !important;
    }
    .fresh-table .bootstrap-table .table tbody > tr > td {
      padding-left: .75rem !important;
    }
    .fresh-table .bootstrap-table .table tbody > tr > td {
      padding: .75rem !important;
    }
    .fresh-table .bootstrap-table .table tbody > tr > td:nth-child(1) {
      padding: 0px !important;
    }
    .input-group{
      position: relative;
      display: flex;
      flex-wrap: wrap;
      align-items: stretch;
      width: 100%;
    }
    .input_box{
      display: block;
      width: 100px;
      padding: .375rem .75rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #212529;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      appearance: none;
      border-radius: .25rem;
      transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    .input_box_text{
      display: flex;
      align-items: center;
      padding: .375rem .75rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #212529;
      text-align: center;
      white-space: nowrap;
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: .25rem;
    }
    .input-group>.input_box{
      position: relative;
      flex: 1 1 auto;
      width: 1%;
      min-width: 0;
    }
    
    * { font-family: 'Spoqa Han Sans Neo', 'sans-serif' !important;}
  </style>
  <script src="js/craft_recipe.js" > </script>
  <script>
    var jsonsave;
    var jsondate;
    var $table = $('#fresh-table');

    function recipecalc(){
      tabledata = [];
      
      recipedata.forEach(function(recipe){
        itemname = Object.keys(recipe)[0];
        recipe = recipe[Object.keys(recipe)[0]];

        type = recipe['분류'];
        if(type == '배틀아이템'){
          type = "b";
        }else if(type == "요리"){
          type = "c";
        }else if(type == "특수"){
          type = "s";
        }
        qty = recipe['수량'];
        e = recipe['활동력'];
        
        craftprice = 0;
        for (var i = 3; i < Object.keys(recipe).length; i++) {
          thisitemname = Object.keys(recipe)[i];
          if(thisitemname.lastIndexOf('(') != -1){
            thisitemname = thisitemname.substr(0, thisitemname.lastIndexOf('('));
          }
          thisitmeqty = recipe[Object.keys(recipe)[i]];

          if(thisitemname == '실링'){
            calcprice = 0;
          }else if(thisitemname == "골드"){
            thissale = parseInt($('#cc_' + type).val()) + parseInt($('#cc_all').val());
            if(thissale == 0){
              calcprice = thisitmeqty;
            }else{
              calcprice = thisitmeqty - (thisitmeqty * (thissale / 100));
            }
          }else{
            try{
              thisunit = itemunit[Object.keys(recipe)[i]];
              if(thisunit == undefined){
                thisunit = 1;
              }
            }catch{}
            marketprice = jsonsave[thisitemname];
            if(Object.keys(recipe)[i].lastIndexOf('제작)') != -1){
              for (var j = 0; j < tabledata.length; j++) {
                if(tabledata[j]['item'] == thisitemname){
                  marketprice = tabledata[j]['craftprice'] / recipe[Object.keys(recipe)[i]];
                  break;
                }
              }
            }

            calcprice = marketprice * (thisitmeqty / thisunit);
          }
          craftprice += calcprice;
        }

        thisbuyprice = jsonsave[itemname]
        if(itemname.lastIndexOf('(') != -1){
          thisbuyprice = jsonsave[itemname.substr(0, itemname.lastIndexOf('('))];
        }

        thisgs = parseInt($('#gs_' + type).val()) + parseInt($('#gs_all').val()) + 5;
        if(thisgs == 5){
          gsqty = qty + (qty * (5/100));
        }else{
          gsqty = ((((((parseInt($('#gs_' + type).val()) + parseInt($('#gs_all').val())) / 10) / 2) + 5) * qty) / 100) + qty;
        }
        thisprofit = ((thisbuyprice - Math.ceil(thisbuyprice * 0.05)) * gsqty - craftprice);

        this_e = parseInt($('#e_' + type).val()) + parseInt($('#e_all').val());
        if(this_e == 0){
          es = e;
        }else{
          es = e - (e * (this_e / 100));
        }

        if(thisbuyprice > (craftprice / qty)){
          thisrecommend =  "제작";
        }else{
          thisrecommend =  "구매";
        }

        tabledata.push({item: itemname,
                recommend: thisrecommend,
                buyprice: thisbuyprice,
                craftprice: craftprice.toFixed(2),
                profit: thisprofit.toFixed(2),
                profitperenergy: parseInt((10000 / es) * thisprofit),
                dict: recipe,
                es: es,
                gsqty: gsqty

        });
      });

      $table.bootstrapTable('load', tabledata);
    }
    
    function detailFormatter(index, row) {
      html = "";
      html += `<table class="table" style="cursor:auto;">
  <thead>
    <tr>
      <th scope="col">시세</th>
      <th scope="col">판매수수료</th>
      <th scope="col">제작비용(개당)</th>
      <th scope="col">재료</th>
      <th scope="col">개수</th>
      <th scope="col">가격</th>
      <th scope="col">제작비용</th>
      <th scope="col">활동력</th>
      <th scope="col">활동력 X<p>활동력 감소율</th>
      <th scope="col">수량</th>
      <th scope="col">수량 X<p>대성공</th>
      <th scope="col">이익</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td scope="row">${row['buyprice']}</td>
      <td>${Math.ceil(row['buyprice'] * 0.05)}</td>
      <td>${(row['craftprice'] / row['dict']['수량']).toFixed(2)}</td>
      <td>`;

      for (var i = 3; i < Object.keys(row['dict']).length; i++) {
        html += `<p>${Object.keys(row['dict'])[i]}</p>`;
      }

      html += `</td>
      <td>`;
       
      for (var i = 3; i < Object.keys(row['dict']).length; i++) {
        html += `<p>${row['dict'][Object.keys(row['dict'])[i]]}</p>`;
      }

      html += `</td>
      <td>`;
      
      for (var i = 3; i < Object.keys(row['dict']).length; i++) {
        thisitemname = Object.keys(row['dict'])[i];
        if(thisitemname.lastIndexOf('(') != -1){
          thisitemname = thisitemname.substr(0, thisitemname.lastIndexOf('('));
        }
        if(thisitemname == "실링"){
          calcprice = 0;

        }else if(thisitemname == "골드"){
          thissale = parseInt($('#cc_' + type).val()) + parseInt($('#cc_all').val());
          if(thissale == 0){
            calcprice = row['dict'][Object.keys(row['dict'])[i]];
          }else{
            calcprice = row['dict'][Object.keys(row['dict'])[i]] - (row['dict'][Object.keys(row['dict'])[i]] * (thissale / 100));
          }
        }else{
          try{
            thisunit = itemunit[Object.keys(row['dict'])[i]];
            if(thisunit == undefined){
              thisunit = 1;
            }
          }catch{}
          marketprice = jsonsave[thisitemname];
          calcprice = (marketprice / thisunit) * row['dict'][Object.keys(row['dict'])[i]]
          if(Object.keys(row['dict'])[i].lastIndexOf('제작)') != -1){
            for (var j = 0; j < tabledata.length; j++) {
              if(tabledata[j]['item'] == thisitemname){
                calcprice = (tabledata[j]['craftprice'] * row['dict'][Object.keys(row['dict'])[i]]) / tabledata[j]['dict']['수량'];
                break;
              }
            }
          }
        }
        html += `<p>${calcprice.toFixed(2)}</p>`;
      }
      html +=`<td>${row['craftprice']}</td>
      <td>${row['dict']['활동력']}</td>
      <td>${row['es']}</td>
      <td>${row['dict']['수량']}</td>
      <td>${row['gsqty']}</td>
      <td>${row['profit']}</td>
    </tr>
  </tbody>
</table>`;
      return html;
    }

    function imageFormatter(index, row) {
      if(row['item'].lastIndexOf('(') != -1){
        thisname = row['item'].substr(0, row['item'].lastIndexOf('('));
      }else{
        thisname = row['item'];
      }

      if(recipeimg[thisname] && recipeimg[thisname].length > 0){
        image = recipeimg[thisname][0];
        grade = recipeimg[thisname][1];
      }
      return '<img class="item-image mt-1 mb-1" data-grade="' + grade + '" src="https://cdn-lostark.game.onstove.com/EFUI_IconAtlas/' + image + '.png" style="width: 64px;">'
    }

    function recomcellStyle(value, row, index) {
      if (row['recommend'] == '구매') {
        return {
          css: {
            color: 'red'
          }
        }
      }else{
        return {
          css: {
            color: '#00ff00'
          }
        }
      }
    }

    function profcellStyle(value, row, index) {
      if (row['profit'] <= 0) {
        return {
          css: {
            color: 'red'
          }
        }
      }else{
        return {
          css: {
            color: '#00ff00'
          }
        }
      }
    }

    $(function(){


      $table.bootstrapTable({
        classes: 'table table-hover table-striped',
        toolbar: '.toolbar',
        search: true,
        pagination: true,
        striped: true,
        pageSize: 10,
        pageList: [10, 25, 50, 100],

        formatShowingRows: function(pageFrom, pageTo, totalRows){
          return ''
        },
        formatRecordsPerPage: function (pageNumber) {
          jsondate = String(jsondate);
          db_year = jsondate.slice(0,4);
          db_mon = jsondate.slice(4,6);
          db_day = jsondate.slice(6,8);
          db_hour = jsondate.slice(8,10);
          db_min = jsondate.slice(10,12);

          return pageNumber + ' 아이템 값 기준 : ' + db_year + "-" + db_mon + "-" + db_day + " " + db_hour + ":" + db_min + " 기준"
        },
      })

      if ($.cookie("gs_all") == "" || $.cookie("gs_all") == undefined || url == "http://127.0.0.1:5000"){
        $('#wisdomeffect').find('input').filter(function(){
          $(this).val(0);
        });
      }else{
        $('#wisdomeffect').find('input').filter(function(){
          $(this).val($.cookie($(this).attr('id')));
        });
        recipecalcwait();
      }

      $('#wisdomeffect').find('input').filter(function(){
        $(this).on('change', function(){
          thiseffectname = $(this).attr('id');
          thiseffectval = $(this).val();
          if(thiseffectval == undefined || thiseffectval == '' || parseInt(thiseffectval) < 0){
            $(this).val(0);
            thiseffectval = 0;
          }
          $.cookie(thiseffectname, thiseffectval);
        });
      });

      function recipecalcwait() {
        setTimeout(() => {
          recipecalc();
          tost.hideToast();
        }, 350);
      }

      $('#wisdomedit').on('click', async function(){
        tost = Toastify({
                        text: "계산중...",
                        position: "center",
                        gravity: "bottom",
                        duration: -1,
                        close: false
                        }).showToast();
        await recipecalcwait();
      });

      $.ajax({
        type: 'POST',
        url: url + '/craftcalc',
        success: function(json) {
          jsonsave = json;
          jsondate = jsonsave['date'];

          recipecalc();
        }
      });
    });

  </script>
  <div class="modal fade bd-example-modal-lg" id="MA" tabindex="-1" aria-labelledby="MALabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-black">도움말</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-black">
          <div>
            <img src="img\wisdom.png">
            <p>▲ 위와 같이 제작 대성공 확률 4% 니까 밑에 전체에 4입력</p>
            <p>[배틀 아이템 - 폭탄] 제작 대성공 확률 3% 증가니까 밑에 배틀아이템에 3입력</p>
            <p>[요리] 제작 대성공 확률 1% 증가니까 밑에 요리에 1입력</p>
            <img src="img\wisdomeffect.png">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn btn-outline-dark text-black" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
