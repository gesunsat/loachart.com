<!DOCTYPE html>
<html lang="ko">
<head class="h-100">
  <title>제작 :: LoaChart</title>
  <meta name="description" content="로스트아크 실시간 제작 이득 계산기">
  <script>var here = "craftcalc";</script>

  <link rel="stylesheet" href="https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css" type="text/css">

  <!-- jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="js/jquery.cookie-1.4.1.min.js"></script>
  <script src="js/jquery.mousewheel.min.js"></script>

  <!-- bootstrap -->
  <script async src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">

  <!-- bootstrap-table -->
  <script defer src="https://unpkg.com/bootstrap-table/dist/bootstrap-table.min.js"></script>
  <link href="css/fresh-bootstrap-table.css" rel="stylesheet" />

  <!-- custom -->
  <script async src="js/custom.js"></script>
  <link rel="stylesheet" type="text/css" href="css/custom.css">
  
  <style>
    @media (max-width: 1008px) {
      .container, .container-md, .container-sm {
        max-width: 970px !important;
      }
    }

    .accordion-button {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      padding: 1rem 1.25rem;
      font-size: 1rem;
      color: #ffffff;
      text-align: left;
      background-color: #000;
      border: 0;
      border-radius: 0;
      overflow-anchor: none;
      transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out,border-radius .15s ease;
    }
    .accordion-button:not(.collapsed) {
      color: #ffffff;
      background-color: #606060;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
    }
    .accordion-button::after {
      flex-shrink: 0;
      width: 1.25rem;
      height: 1.25rem;
      margin-left: auto;
      content: "";
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='white'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-size: 1.25rem;
      transition: transform .2s ease-in-out;
    }
    .accordion-button:not(.collapsed)::after {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='white'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
      transform: rotate(-180deg);
    }
  </style>
  <link href="css/cover.css" rel="stylesheet">
</head>

<body class="d-flex h-100 text-center text-white bg-dark">    
  <div class="container d-flex w-100 h-100 p-3 mx-auto flex-column">

    <header class="mb-3">
      <div>
        <a href="/"><h3 class="float-md-start mb-0 text-white">LoaChart</h3></a>
        <nav class="nav nav-masthead justify-content-center float-md-end">
        </nav>
      </div>
    </header>

    <main class="pt-5 pb-5 px-3">
      <div class="text-center">

      <!-- temp ad -->
      <div class="ad mb-5">
        <div>
          <div class="text-center">
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XJwlOkv1K5GXhAIz" 
            data-ad-width   = "728" 
            data-ad-height  = "90"></ins>
          </div>
        </div>
        <div id="ads-left">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-nsfEeS2PlFxohWoX" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
        <div id="ads-right">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XoJlI1MzVRSxM5dr" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
      </div>
      
      <div class="mx-auto w-100 pt-5 pb-5">
        <div class="accordion" id="accordionitemprice">
          <div class="accordion-item mb-3">
            <h2 class="accordion-header" id="heading1" style="margin-top:0px;">
              <button style="background-color: #000 important;" class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1" aria-expanded="false" aria-controls="collapse1">
                재료 시세(수정 가능) <span id="markettime"></span>
              </button>
            </h2>
            <div id="collapse1" class="accordion-collapse collapse" aria-labelledby="heading1" data-bs-parent="#accordionitemprice" style="">
              <div class="accordion-body p-0" style="background-color: #212529;">
                <div class="container">
                  <div class="row" >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="fresh-table full-color-custom">
          <div class="toolbar text-start">
            <button class="btn btn-default" data-bs-toggle="collapse" data-bs-target="#collapse">영지 효과</button>
            <div class="accordion" style="width: 584px;">
              <div id="collapse" class="accor dion-collapse collapse" aria-labelledby="heading" data-bs-parent="#accordion">
                <div class="accordion-body p-0">
                  <table class="table mt-3 table-hover mb-3 text-center">
                    <thead>
                      <tr>
                        <th scope="col">전체</th>
                        <th scope="col">배틀아이템</th>
                        <th scope="col">요리</th>
                        <th scope="col">특수</th>
                      </tr>
                    </thead>
                    <tbody class="align-middle" id="wisdomeffect">
                      <tr>
                        <td colspan="5">
                          대성공 확률
                          <i class="bi bi-question-circle-fill" onmouseover="tippy($(this)[0], { allowHTML: true, content: '대성공 확률이 0일 경우에는 기본 대성공 확률 5% 반영 X<br>-------------------------------------------------------<br>기본 대성공 <FONT COLOR=`#bd0000`>5%</FONT>에서 영지효과 곱연산<br>Ex) 대성공 확률 <FONT COLOR=`#0000ff`>6%</FONT>일 경우 <FONT COLOR=`#bd0000`>5</FONT> + (<FONT COLOR=`#bd0000`>5</FONT> X <FONT COLOR=`#0000ff`>0.06</FONT> = 5.3%)',theme: 'light', placement: 'right', });"></i>
                        </td>
                      </tr>
                      <tr>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="gs_all" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="gs_b" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="gs_c" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="gs_s" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                      </tr>
                      <tr>
                        <td colspan="5">제작 수수료 감소율</td>
                      </tr>
                      <tr>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="cc_all" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="cc_b" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="cc_c" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="cc_s" value="0">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                      </tr>
                      <tr>
                        <td colspan="5">활동력 감소율</td>
                      </tr>
                      <tr>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="e_all" value="0" max="100">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="e_b" value="0" max="100">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="e_c" value="0" max="100">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                        <th>
                          <div class="input-group">
                            <input type="number" class="input_box" id="e_s" value="0" max="100">
                            <span class="input-group-text">%</span>
                          </div>
                        </th>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="text-center">
                  <button id="wisdomeffectclear" class="btn btn-primary">초기화</button>
                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#help" id="helpbtn">도움말</button>
                </div>
              </div>
            </div>
          </div>
          <table id="fresh-table" 
                 class="table"
                 data-detail-view="true"
                 data-detail-view-icon="false"
                 data-detail-view-by-click="true"
                 data-detail-formatter="detailFormatter"
                 data-sort-name="profit"
                 data-sort-order="desc">
            <thead>
              <th data-field="image" data-formatter="imageFormatter"></th>
              <th class="text-start" data-field="item" data-sortable="true">아이템</th>
              <th data-field="recommend" data-sortable="true" data-cell-style="recomcellStyle">추천방식</th>
              <th data-field="buyprice" data-sortable="true">시세</th>
              <th data-field="craftprice" data-sortable="true">제작비용</th>
              <th data-field="profit" data-sortable="true" data-cell-style="profcellStyle">판매이익</th>
              <th data-field="profitperenergy" data-sortable="true" data-formatter="profitperenergyFormatter">이익/활동력  <i class="bi bi-question-circle-fill" onmouseover="tippy($(this)[0], { allowHTML: true, content: '(최대 활동력 10,000 ÷ 해당 아이템 활동력) X<br>해당 아이템 판매이익',theme: 'light', placement: 'bottom', });"></i></th>
            </thead>
            <tbody style="cursor:pointer"></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- tempAd -->
    <footer class="mt-5 text-white-50">
      <div class="p-0 m-0 mb-2 text-center">
        <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
        data-ad-unit    = "DAN-wTnO0MIIPOzE9w0o" 
        data-ad-width   = "728" 
        data-ad-height  = "90"></ins> 
      </div>
      
      <!-- AdSense -->
      <div class="ADsense">
        <!-- loa_market_chart -->
        <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4936470262963011"
        data-ad-slot="8129420230"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <p>Cover template for <a href="https://getbootstrap.com/" class="text-white">Bootstrap</a>, by <a href="https://twitter.com/mdo" class="text-white">@mdo</a>.</p>
    </footer>
  </div>
  <style>
    .fresh-table .bootstrap-table .table thead > tr > th:first-child {
      padding-left: 0px !important;
    }
    .bootstrap-table .fixed-table-container .table thead th .sortable {
      padding-right: 0.75rem !important;
    }
    .fresh-table .bootstrap-table .table > thead > tr > th{
      padding: 0px !important;
      font-size: var(--bs-body-font-size) !important;
    }
    .fresh-table .bootstrap-table .table tbody > tr > td {
      padding-left: .75rem !important;
    }
    .fresh-table .bootstrap-table .table tbody > tr > td {
      padding: .75rem !important;
    }
    #fresh-table > tbody > tr > td:nth-child(1) {
      padding: 0px !important;
    }
    .input-group{
      position: relative;
      display: flex;
      flex-wrap: wrap;
      align-items: stretch;
      width: 100%;
    }
    .input_box{
      display: block;
      width: 100px;
      padding: .375rem .75rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #212529;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      appearance: none;
      border-radius: .25rem;
      transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    .input_box_text{
      display: flex;
      align-items: center;
      padding: .375rem .75rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #212529;
      text-align: center;
      white-space: nowrap;
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: .25rem;
    }
    .input-group>.input_box{
      position: relative;
      flex: 1 1 auto;
      width: 1%;
      min-width: 0;
    }

    body,
    .pricetxt,
    .pricehide {
      font: inherit;
      text-align: center!important;
      margin: 0;
      padding: 0;
    }

    .pricetxt {
      border: none;
      color: rgb(255, 255, 255);
      background-color: #606060;
      min-width: 10px;
      cursor: pointer;
    }

    .pricetxt:focus-visible {
      outline: none;
    }

    .pricehide {
      display: none;
      white-space: pre;
    }

    * { font-family: 'Spoqa Han Sans Neo', 'sans-serif' !important;}
  </style>
  <script src="js/craft_recipe.js" > </script>
  <script>
    `
    .pricehide {
      white-space: pre;
      display: inline-block;
      visibility: hidden;
    }

    function hasClass(elem, className) {
      return elem.className.split(' ').indexOf(className) > -1;
    }

    document.querySelector('.fresh-table').addEventListener('input', function(e) {
      if(hasClass(e.target, 'pricetxt')) {
        e.target.parentNode.firstChild.innerText = e.target.value;
        e.target.style.width = String(e.target.parentNode.firstChild.offsetWidth + 16) + "px";
        e.target.parentNode.firstChild.innerText = "";
      }
    });

    <td><span class="pricehide"></span><input class="pricetxt" type="text" value="1" style="width:25.5px"></td>
    <th scope="col">제작개수</th>
    `

    document.querySelector('#helpbtn').addEventListener('click', function(){
      var helpimage = document.createElement('img');
      helpimage.src = "img/wisdom.png";
      document.querySelector('#modalimg1').appendChild(helpimage);
      
      helpimage = document.createElement('img');
      helpimage.src = "img/wisdomeffect.png";
      document.querySelector('#modalimg2').appendChild(helpimage);

      document.querySelector('#helpbtn').removeEventListener('click', arguments.callee);
    }, false);

    var jsonsave;
    var $table = $('#fresh-table');

    function recipecalc(){
      $table.bootstrapTable('load', []);

      tabledata = [];
      temp = [];
      Object.keys(recipedata).forEach(function(item){
        itemname = item;
        if(itemname.lastIndexOf('(') != -1){
          temp.push(itemname.substr(0, itemname.lastIndexOf('(')));
        }else{
          temp.push(itemname);
        }
        recipe = recipedata[item];

        type = recipe['분류'];
        if(type == '배틀아이템'){
          type = "b";
        }else if(type == "요리"){
          type = "c";
        }else if(type == "특수"){
          type = "s";
        }
        qty = recipe['수량'];
        e = recipe['활동력'];
        
        craftprice = 0;
        for (var i = 4; i < Object.keys(recipe).length; i++) {
          thisitemname = Object.keys(recipe)[i];
          if(thisitemname.lastIndexOf('(') != -1){
            thisitemname = thisitemname.substr(0, thisitemname.lastIndexOf('('));
          }
          thisitmeqty = recipe[Object.keys(recipe)[i]];

          if(thisitemname == '실링'){
            calcprice = 0;
          }else if(thisitemname == "골드"){
            thissale = parseInt($('#cc_' + type).val()) + parseInt($('#cc_all').val());
            if(thissale == 0){
              calcprice = thisitmeqty;
            }else{
              calcprice = Math.floor(thisitmeqty - (thisitmeqty * (thissale / 100)));
            }
          }else{
            try{
              thisunit = itemunit[Object.keys(recipe)[i]];
              if(thisunit == undefined){
                thisunit = 1;
              }
            }catch{}
            marketprice = jsonsave[thisitemname];
            if(Object.keys(recipe)[i].lastIndexOf('제작)') != -1){
              for (var j = 0; j < tabledata.length; j++) {
                if(tabledata[j]['item'] == thisitemname){
                  marketprice = (tabledata[j]['craftprice'] / recipe[Object.keys(recipe)[i]]).toFixed(2);
                  break;
                }
              }
            }
            temp.push(thisitemname)
            calcprice = marketprice * (thisitmeqty / thisunit);
          }
          craftprice += calcprice;
        }

        thisbuyprice = jsonsave[itemname]
        if(itemname.lastIndexOf('(') != -1){
          thisbuyprice = jsonsave[itemname.substr(0, itemname.lastIndexOf('('))];
        }

        thisgs = parseInt($('#gs_' + type).val()) + parseInt($('#gs_all').val()) + 5;
        if(thisgs <= 5){
          gsqty = qty;
        }else{
          gsqty = ((((((parseInt($('#gs_' + type).val()) + parseInt($('#gs_all').val())) / 10) / 2) + 5) * qty) / 100) + qty;
        }
        thisprofit = ((thisbuyprice - Math.ceil(thisbuyprice * 0.05)) * gsqty - craftprice);

        this_e = parseInt($('#e_' + type).val()) + parseInt($('#e_all').val());
        if(this_e == 0){
          es = e;
        }else{
          es = e - (e * (this_e / 100));
          if(es == 0){
            es = 1;
          }
        }

        if(thisbuyprice > (craftprice / qty)){
          thisrecommend =  "제작";
        }else{
          thisrecommend =  "구매";
        }
        
        tabledata.push({item: itemname,
                recommend: thisrecommend,
                buyprice: thisbuyprice,
                craftprice: craftprice.toFixed(2),
                profit: thisprofit.toFixed(2),
                profitperenergy: parseInt((Math.floor(10000 / es)) * thisprofit),
                dict: recipe,
                es: es,
                gsqty: gsqty
        });
      });

      $table.bootstrapTable('load', tabledata);
    }

    
    $('#accordionitemprice').on('click', function(){
      $accord = $('#accordionitemprice').find('.row');

      ([...new Set(temp)].sort()).forEach(function(e){
        originE = e;
        try{
          grade = iteminfo[e][1];
          image = iteminfo[e][0];
        }catch{
          if(e.indexOf('빛나는 ') != -1){
            behindE = e.substr(4);
            try{behindE = behindE.replace("정령의 회복약", "정가");}catch{}
            grade = recipedata[e + '('+behindE+' 구매)'].key.Element_001.value.slotData.iconGrade;
            image = recipedata[e + '('+behindE+' 구매)'].key.Element_001.value.slotData.iconPath;
          }else{
            try{e = e.replace("융화 재료", "융화 재료(고고학)");}catch{}
            grade = recipedata[e].key.Element_001.value.slotData.iconGrade;
            image = recipedata[e].key.Element_001.value.slotData.iconPath;
          }
        }
        $accord.append(`<div class="col-3 px-0"><div class="float-start"><img class="item-image" data-grade="${grade}" style="width:32px; height:32px;" src="https://cdn-lostark.game.onstove.com/${image}" alt=""> <span id='itemname' origin="${originE}">${originE.substr(0,14)}</span> : <span class="pricehide"></span><input class="pricetxt" type="text" value="${jsonsave[originE]}"></div>`);
      });

      $(this).off('click');
      $('.pricetxt').filter(function(){
        $(this).parent().find('.pricehide').text($(this).val());
        $(this).width($(this).parent().find('.pricehide').width() + 16);

        $(this).on("mousewheel",function(event,delta){
          event.preventDefault();
          event.stopPropagation();
          if(delta>0){
            $(this).val(parseInt($(this).val()) + 1);
            $(this).parent().find('.pricehide').text($(this).val());
          }else if(delta<0){
            if($(this).val() == 0){return;}
            $(this).val(parseInt($(this).val()) - 1);
            $(this).parent().find('.pricehide').text($(this).val());
          } 
          
          jsonsave[$(this).parent().find('#itemname').attr('origin')] = parseInt($(this).val());
          recipecalc();
        });

        $(this).on('input', function(){
          $(this).parent().find('.pricehide').text($(this).val());
          $(this).width($(this).parent().find('.pricehide').width() + 16);

          if($(this).val() == ''){
            $(this).val(0);
            $(this).parent().find('.pricehide').text(0);
          }
          if($(this).val().indexOf('0') == 0 && $(this).val().length >= 2){
            $(this).val($(this).val().substr(1));
          }
          jsonsave[$(this).parent().find('#itemname').attr('origin')] = parseInt($(this).val());
          recipecalc();
        })

      });
    });

    function detailFormatter(index, row) {
      html = "";
      html += `<table class="table" style="cursor:auto;">
  <thead>
    <tr>
      <th scope="col">시세</th>
      <th scope="col">수수료</th>
      <th scope="col">제작비용<br>(개당)</th>
      <th scope="col">재료</th>
      <th scope="col">시세</th>
      <th scope="col">구매<br>단위</th>
      <th scope="col">필요<br>개수</th>
      <th scope="col">합계</th>
      <th scope="col">제작비용</th>
      <th scope="col">활동력<br>(영지효과)</th>
      <th scope="col">제작 수량<br>(영지효과)</th>
      <th scope="col">이익</th>
    </tr>
  </thead>
  <tbody>`;

    rowitemname = row['item'];
    if(rowitemname.lastIndexOf('제작)') != -1){
      rowitemname = rowitemname.substr(0, rowitemname.lastIndexOf('('));
    }
    
    html += `
    <tr>
      <td>${row['buyprice']}</td>
      <td id="detail-tax">${Math.ceil(row['buyprice'] * 0.05)}</td>
      <td id="detail-craftprice">${(row['craftprice'] / row['dict']['수량']).toFixed(2)}</td>
      <td>`;
      // 재료
      for (var i = 4; i < Object.keys(row['dict']).length; i++) {
        html += `<p>${Object.keys(row['dict'])[i]}</p>`;
      }

      html += `</td>
      <td>`;

      // 재료시세
      for (var i = 4; i < Object.keys(row['dict']).length; i++) {
        thisitemname = Object.keys(row['dict'])[i];
        if(thisitemname.lastIndexOf('(') != -1){
          thisitemname = thisitemname.substr(0, thisitemname.lastIndexOf('('));
        }
        if(thisitemname == "실링"){
          price = 0;
        }else if(thisitemname == "골드"){
          price = row['dict'][Object.keys(row['dict'])[i]];
        }else{
          price = jsonsave[thisitemname];
          if(Object.keys(row['dict'])[i].lastIndexOf('제작)') != -1){
            for (var j = 0; j < tabledata.length; j++) {
              if(tabledata[j]['item'] == thisitemname){
                price = ((tabledata[j]['craftprice'] * row['dict'][Object.keys(row['dict'])[i]]) / tabledata[j]['dict']['수량']) / row['dict'][Object.keys(row['dict'])[i]];
                price = price.toFixed(2);
                break;
              }
            }
          }
        }
        html += `<p>${price}</p>`;
      }

      html += `</td>
      <td>`;

      // 구매 단위
      for (var i = 4; i < Object.keys(row['dict']).length; i++) {
        thisitemname = Object.keys(row['dict'])[i];
        if(thisitemname.lastIndexOf('(') != -1){
          thisitemname = thisitemname.substr(0, thisitemname.lastIndexOf('('));
        }
        unit = itemunit[thisitemname];
        if(unit == undefined){
          unit = 1;
        }

        html += `<p>${unit}</p>`;
      }

      html += `</td>
      <td>`;

      // 재료 개수
      for (var i = 4; i < Object.keys(row['dict']).length; i++) {
        thisitemname = Object.keys(row['dict'])[i];
        if(thisitemname.lastIndexOf('(') != -1){
          thisitemname = thisitemname.substr(0, thisitemname.lastIndexOf('('));
        }
        if(thisitemname == "실링" || thisitemname == "골드"){
          qty = 1;
        }else{
         qty = row['dict'][Object.keys(row['dict'])[i]]; 
        }

        html += `<p>${qty}</p>`;
      }

      html += `</td>
      <td>`;
      // 재료 총 가격
      for (var i = 4; i < Object.keys(row['dict']).length; i++) {
        thisitemname = Object.keys(row['dict'])[i];
        if(thisitemname.lastIndexOf('(') != -1){
          thisitemname = thisitemname.substr(0, thisitemname.lastIndexOf('('));
        }
        if(thisitemname == "실링"){
          calcprice = 0;
        }else if(thisitemname == "골드"){
          thissale = parseInt($('#cc_' + type).val()) + parseInt($('#cc_all').val());
          if(thissale == 0){
            calcprice = row['dict'][Object.keys(row['dict'])[i]];
          }else{
            calcprice = Math.floor(row['dict'][Object.keys(row['dict'])[i]] - (row['dict'][Object.keys(row['dict'])[i]] * (thissale / 100)));
          }
        }else{
          try{
            thisunit = itemunit[Object.keys(row['dict'])[i]];
            if(thisunit == undefined){
              thisunit = 1;
            }
          }catch{}
          marketprice = jsonsave[thisitemname];
          calcprice = ((marketprice / thisunit) * row['dict'][Object.keys(row['dict'])[i]]).toFixed(2)
          if(Object.keys(row['dict'])[i].lastIndexOf('제작)') != -1){
            for (var j = 0; j < tabledata.length; j++) {
              if(tabledata[j]['item'] == thisitemname){
                calcprice = ((tabledata[j]['craftprice'] / tabledata[j]['dict']['수량']).toFixed(2) * row['dict'][Object.keys(row['dict'])[i]]).toFixed(2);
                break;
              }
            }
          }
        }
        html += `<p>${calcprice}</p>`;
      }
      html +=`<td>${row['craftprice']}</td>
      <td>${row['dict']['활동력']}<br>(${row['es']})</td>
      <td>${row['dict']['수량']}<br>(${row['gsqty']} <i class="bi bi-question-circle-fill" onmouseover="tippy($(this)[0], { content: '기본 대성공 5%에서 영지효과 곱연산',theme: 'light', placement: 'bottom', });"></i>)</td>
      <td>${row['profit']}</td>
    </tr>
  </tbody>
</table>`;
      return html;
    }

    function imageFormatter(index, row) {
      if(row['item'].lastIndexOf('(') != -1){
        thisname = row['item'].substr(0, row['item'].lastIndexOf('('));
      }else{
        thisname = row['item'];
      }

      image = row.dict.key.Element_001.value.slotData.iconPath;
      grade = row.dict.key.Element_001.value.slotData.iconGrade;

      return '<img data-key="' + JSON.stringify(row.dict.key).replace(/"/gi, "&quot;") + '" class="item-image mt-1 mb-1" data-grade="' + grade + '" src="https://cdn-lostark.game.onstove.com/' + image + '" onmouseover="tooltip_item_show(this);" onmouseout="tooltip_item_hide(this);" style="width: 64px;">'
    }

    function tooltip_item_show(e){
      offtop = $(e).offset().top;
      offleft = $(e).offset().left + 75;
      keydata = JSON.parse($(e).attr('data-key'));

      tooltiphtml = `<div class="itemdic-item game-tooltip game-tooltip-item" style="position: absolute; left: ${offleft}px; top: ${offtop}px;">`;

      Object.keys(keydata).forEach(function(e){
        tooltiphtml += `<div class="${keydata[e]['type']}">`;
        if(keydata[e]['type'] == "ItemTitle"){
          tooltiphtml += `<span class="slotData" data-grade="${keydata[e]['value']['slotData']['iconGrade']}"><img src="https://cdn-lostark.game.onstove.com/${keydata[e]['value']['slotData']['iconPath']}" alt="" data-grade="${keydata[e]['value']['slotData']['iconGrade']}" class="item-image"}></span>`;
          try{
            delete keydata[e]['value']['slotData'];
          }catch{}
          Object.keys(keydata[e]['value']).forEach(function(f){
            tooltiphtml += `<span class="${f}">${keydata[e]['value'][f]}</span>`;
          });
        }else if(keydata[e]['type'] == "MultiTextBox"){
          keyvaluearr = keydata[e]['value'].split('|');
          keyvaluearr.forEach(function(g){
            tooltiphtml += `<span>${g}</span>`;
          });
        }else{
          tooltiphtml += `${keydata[e]['value']}`;
        }
        tooltiphtml += `</div>`;
      });

      $('body').append(tooltiphtml);
    }
    function tooltip_item_hide(e){
      $('body').find('.game-tooltip-item').remove()
    }

    waringitemarr = ['신호탄','회복약'];
    function profitperenergyFormatter(value, row){
      
      if(waringitemarr.indexOf(row['item']) != -1){
        return value + ` <i class="bi bi-exclamation-circle-fill" onmouseover="tippy($(this)[0], { content: '제작 활동력이 1이라서 비상식적인 이득으로 나온 것입니다. 실제론 활동력 1만 못 녹입니다.',theme: 'light', placement: 'bottom', });"></i>`;
      }else{
        return value;
      }
    }

    function recomcellStyle(value, row, index) {
      if (row['recommend'] == '구매') {
        return {
          css: {
            color: 'red'
          }
        }
      }else{
        return {
          css: {
            color: '#00ff00'
          }
        }
      }
    }

    function profcellStyle(value, row, index) {
      if (row['profit'] <= 0) {
        return {
          css: {
            color: 'red'
          }
        }
      }else{
        return {
          css: {
            color: '#00ff00'
          }
        }
      }
    }

    $(function(){
      $table.bootstrapTable({
        classes: 'table table-hover table-striped',
        toolbar: '.toolbar',
        search: true,
        pagination: true,
        striped: true,
        pageSize: 10,
        pageList: [10, 25, 50, 100],

        formatShowingRows: function(pageFrom, pageTo, totalRows){
          return ''
        },
        formatRecordsPerPage: function (pageNumber) {
          return pageNumber + ' rows visible'
        },
      })

      $('#wisdomeffectclear').on('click', function(){
        $('#wisdomeffect').find('input').filter(function(){
          $(this).val(0);
          $.cookie($(this).attr('id'), 0);
          recipecalc();
        });
      });

      $('#wisdomeffect').find('input').filter(function(){
        givemeid = $(this).attr('id');
        if($.cookie(givemeid) == undefined || $.cookie(givemeid) == ''){
          $(this).val(0);
        }else {
          $(this).val($.cookie(givemeid));
        }

        $(this).on('input', function(){
          thiseffectname = $(this).attr('id');
          thiseffectval = $(this).val();
          if(thiseffectval == undefined || thiseffectval == '' || parseInt(thiseffectval) < 0){
            $(this).val(0);
            thiseffectval = 0;
          }
          $.cookie(thiseffectname, thiseffectval, { expires: 365 });
          recipecalc();
        });
      });

      $.ajax({
        type: 'POST',
        url: url + '/craftcalc',
        success: function(json) {
          jsonsave = json;

          jsondate = String(jsonsave['date']);
          db_year = jsondate.slice(0,4);
          db_mon = jsondate.slice(4,6);
          db_day = jsondate.slice(6,8);
          db_hour = jsondate.slice(8,10);
          db_min = jsondate.slice(10,12);

          $('#markettime').text('[' + db_year + "-" + db_mon + "-" + db_day + " " + db_hour + ":" + db_min + " 기준]");

          recipecalc();
        }
      });
    });

  </script>
  <div class="modal fade bd-example-modal-lg" id="help" tabindex="-1" aria-labelledby="helpLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-black">도움말</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-black">
          <div>
            <p id="modalimg1"></p>
            <p>▲ 위와 같이 제작 대성공 확률 4% 증가니까 밑에 전체에 4입력</p>
            <p>[배틀 아이템 - 폭탄] 제작 대성공 확률 3% 증가니까 밑에 배틀아이템에 3입력</p>
            <p>[요리] 제작 대성공 확률 1% 증가니까 밑에 요리에 1입력</p>
            <p id="modalimg2"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn btn-outline-dark text-black" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- tippyJS -->
  <script async src="https://unpkg.com/@popperjs/core@2.11.5/dist/umd/popper.min.js"></script>
  <script async src="https://unpkg.com/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6.3.7/themes/light.css">

  <!-- google ADSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4936470262963011"
     crossorigin="anonymous"></script>

  <!-- adshield -->
  <script src="https://cdn.jsdelivr.net/npm/jnippij@latest/dist/script.min.js"></script>
  <meta name="adshield-analytics-verification" content="10814fdc-b72d-4655-9ff4-e16976e25f7e"/>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XD44D79GLY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XD44D79GLY');
  </script>

  <!-- Mircrosoft Clarity -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "bohv5f4wfu");
  </script>
</body>
</html>
