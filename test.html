<!DOCTYPE html>
<html lang="ko">
<head class="h-100">
  <title>몰루 :: LoChart</title>
  <meta name="description" content="몰루">
  <script>var here = "몰루";</script>

  <!-- jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="js/jquery.cookie-1.4.1.min.js" > </script>

  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

  <!-- custom -->
  <script src="js/custom.js"></script>
  <link rel="stylesheet" type="text/css" href="css/custom.css">

  <!-- google ADSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4936470262963011"
     crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/ubhor-phi@latest/dist/script.min.js"></script>
  <meta name="adshield-analytics-verification" content="d7b8eb3d-f8fa-41ae-9794-c05e2ed4deb8"/>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XD44D79GLY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XD44D79GLY');
  </script>

  <style>
    @media (max-width: 992px) {
      .w-50 {
        width: 100%!important;
      }
    }
    body {
      font-family: sans-serif;
    }
    a {
      color: #369;
    }
    .note {
      width: 500px;
      margin: 50px auto;
      font-size: 1.1em;
      color: #333;
      text-align: justify;
    }
    #drop-area {
      border: 2px dashed #ccc;
      border-radius: 20px;
      width: 480px;
      margin: 50px auto;
      padding: 20px;
    }
    #drop-area.highlight {
      border-color: purple;
    }
    p {
      margin-top: 0;
    }
    .my-form {
      margin-bottom: 10px;
    }
    #gallery {
      margin-top: 10px;
    }
    #gallery img {
      width: 150px;
      margin-bottom: 10px;
      margin-right: 10px;
      vertical-align: middle;
    }
    .button {
      display: inline-block;
      padding: 10px;
      background: #ccc;
      cursor: pointer;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .button:hover {
      background: #ddd;
    }
    #fileElem {
      display: none;
    }
  </style>
  <link href="css/cover.css" rel="stylesheet">
</head>

<body class="d-flex h-100 text-center text-white bg-dark">
  <div class="container d-flex w-100 h-100 p-3 mx-auto flex-column">

    <header class="mb-3">
      <div>
        <a href="/"><h3 class="float-md-start mb-0 text-white">LoChart</h3></a>
        <nav class="nav nav-masthead justify-content-center float-md-end"></nav>
      </div>
    </header>

    <main class="pt-5 pb-5 px-3">
      <div class="text-center">
      <!-- temp ad -->
      <div class="ad mb-5">
        <div>
          <div class="text-center">
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XJwlOkv1K5GXhAIz" 
            data-ad-width   = "728" 
            data-ad-height  = "90"></ins>
          </div>
        </div>
        <div id="ads-left">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-nsfEeS2PlFxohWoX" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
        <div id="ads-right">
          <div>
            <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
            data-ad-unit    = "DAN-XoJlI1MzVRSxM5dr" 
            data-ad-width   = "160" 
            data-ad-height  = "600"></ins> 
          </div>
        </div>
      </div>
      
      <div class="mx-auto w-50 pt-5">
        <div id="drop-area">
          <form class="my-form">
            <p>Upload multiple files with the file dialog or by dragging and dropping images onto the dashed region</p>
            <input type="file" id="fileElem" multiple accept="image/*" onchange="handleFiles(this.files)">
            <label class="button" for="fileElem">Select some files</label>
          </form>
          <progress id="progress-bar" max=100 value=0></progress>
          <div id="gallery"></div>
        </div>

        <canvas id="template" width="40" height="40"></canvas>

        <button id="Erosion">Erosion</button>

        <div id="canvaszone">
          <canvas id="canvasOutput"></canvas>
        </div>
      </div>
    </main>

    <!-- tempAd -->
    <footer class="mt-5 text-white-50">
      <div class="p-0 m-0 mb-2 text-center">
        <ins class="kakao_ad_area" style="display:none;" rel="nofollow"
        data-ad-unit    = "DAN-wTnO0MIIPOzE9w0o" 
        data-ad-width   = "728" 
        data-ad-height  = "90"></ins> 
      </div>
      
      <!-- AdSense -->
      <div class="ADsense">
        <!-- loa_market_chart -->
        <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4936470262963011"
        data-ad-slot="8129420230"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
      <p>Cover template for <a href="https://getbootstrap.com/" class="text-white">Bootstrap</a>, by <a href="https://twitter.com/mdo" class="text-white">@mdo</a>.</p>
    </footer>
  </div>

  <script async src="js/opencv.js" onload="console.log('opencv ready');"></script>
  <script async src="js/cardlist.js" onload="console.log('cardlist ready');"></script>

  <script>
    // ************************ Drag and drop ***************** //
    let dropArea = document.getElementById("drop-area")

    // Prevent default drag behaviors
    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false)   
      document.body.addEventListener(eventName, preventDefaults, false)
    })

    // Highlight drop area when item is dragged over it
    ;['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false)
    })

    ;['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false)
    })

    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false)

    function preventDefaults (e) {
      e.preventDefault()
      e.stopPropagation()
    }

    function highlight(e) {
      dropArea.classList.add('highlight')
    }

    function unhighlight(e) {
      dropArea.classList.remove('active')
    }

    function handleDrop(e) {
      var dt = e.dataTransfer
      var files = dt.files

      handleFiles(files)
    }

    let uploadProgress = []
    let progressBar = document.getElementById('progress-bar')

    function initializeProgress(numFiles) {
      progressBar.value = 0
      uploadProgress = []

      for(let i = numFiles; i > 0; i--) {
        uploadProgress.push(0)
      }
    }

    function updateProgress(fileNumber, percent) {
      uploadProgress[fileNumber] = percent
      let total = uploadProgress.reduce((tot, curr) => tot + curr, 0) / uploadProgress.length
      progressBar.value = total
    }

    function handleFiles(files) {
      files = [...files]
      initializeProgress(files.length)
      //files.forEach(uploadFile)
      files.forEach(previewFile)
    }

    function previewFile(file) {
      let reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onloadend = async function() {
        var canvasimage = new Image();
        var cardremoveimage = new Image();
        canvasimage.src = reader.result;
        cardremoveimage.src = cardremovebase64;
        await new Promise(r => {
          canvasimage.onload = r
          cardremoveimage.onload = r
        })
        var canvas = cv.imread(canvasimage);
        var cardremove = cv.imread(cardremoveimage);

        let mask = new cv.Mat();
        var method  = cv.TM_CCORR_NORMED;

        let result_cols =   canvas.cols - cardremove.cols + 1;
        let result_rows =   canvas.rows - cardremove.rows + 1;

        var result = new cv.Mat(result_rows, result_rows, cv.CV_32FC1);

        cv.matchTemplate(canvas, cardremove, result, method, mask);

        cv.normalize(result, result, 0, 1, cv.NORM_MINMAX, -1, new cv.Mat() );

        let minMaxLoc   =   cv.minMaxLoc(result);

        let matchLoc;

        if(method == cv.TM_SQDIFF || method == cv.TM_SQDIFF_NORMED){
            matchLoc  = minMaxLoc.minLoc;
        }else{
            matchLoc  = minMaxLoc.maxLoc;
        }

        var cardremovex = matchLoc.x;
        var cardremovey = matchLoc.y;
        var startX = cardremovex - 1101;
        var startY = cardremovey + 92;

        var carddeck = [];
        let template;
        var templateimage;
        let dst;
        let rect;
        
        for (var i = 0; i < Object.keys(cardlist).length; i++) {
          templateimage = new Image();
          templateimage.src = Object.keys(cardlist)[i];
          await new Promise(r => {
            templateimage.onload = r
          })
          template = cv.imread(templateimage);

          for (var j = 0; j < 4; j++) {
            y = startY + (j * 182);
            for (var k = 0; k < 10; k++) {
              if(((j*10) + k) == 40){
                break;
              }
              dst = new cv.Mat();
              mask = new cv.Mat();
              rect = new cv.Rect(0,0,0,0);

              x = startX + (k * 118);
              
              rect = new cv.Rect(x, y, 116, 164);
              source = canvas.roi(rect);

              method  =   cv.TM_CCORR_NORMED;

              result_cols =   source.cols - template.cols + 1;
              result_rows =   source.rows - template.rows + 1;

              result      =   new cv.Mat(result_rows, result_rows, cv.CV_32FC1);

              cv.matchTemplate(source, template, result, method, mask);

              cv.normalize(result, result, 0, 1, cv.NORM_MINMAX, -1, new cv.Mat() );

              minMaxLoc   =   cv.minMaxLoc(result);

              if(method == cv.TM_SQDIFF || method == cv.TM_SQDIFF_NORMED){
                  matchLoc  = minMaxLoc.minLoc;
              }else{
                  matchLoc  = minMaxLoc.maxLoc;
              }

              if(matchLoc.x == 38 && matchLoc.y == 38){
                for (var l = 5; l > 0; l--) {
                  console.log(92 - (Math.abs(l-5) * 15));
                  console.log(source.ucharAt(137, (92 - (Math.abs(l-5) * 15)) * source.channels()))
                }
                carddeck.push(cardlist[Object.keys(cardlist)[i]]);
                j=4;k=10;
              }

              result.delete();source.delete();mask.delete()
            }
          }
          template.delete();
        }
        canvas.delete(),cardremove.delete();
        console.log(carddeck);
      }
    }

    function uploadFile(file, i) {
      var formData = new FormData()
      xhr.open('POST', url, true)
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')

      // Update progress (can be used to show progress indicator)
      xhr.upload.addEventListener("progress", function(e) {
        updateProgress(i, (e.loaded * 100.0 / e.total) || 100)
      })

      xhr.addEventListener('readystatechange', function(e) {
        if (xhr.readyState == 4 && xhr.status == 200) {
          updateProgress(i, 100) // <- Add this
        }
        else if (xhr.readyState == 4 && xhr.status != 200) {
          // Error. Inform the user
        }
      })
      
      formData.append('upload_preset', 'ujpu6gyk')
      formData.append('file', file)
      xhr.send(formData)
    }

    

    $('#Erosion').on('click', function(){

    })
  </script>
</body>
</html>